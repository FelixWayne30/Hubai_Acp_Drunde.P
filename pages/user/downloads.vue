<template>
  <view class="container">
    <view class="background">
      <image class="background-image" src="/static/background/user-download.png" mode="aspectFill"></image>
    </view>

    <view class="content">
      <view class="header">
        <view class="title">下载记录</view>
      </view>
      
      <view class="filter-bar">
        <view 
          class="filter-item" 
          :class="{'active': activeFilter === 'all'}"
          @click="setFilter('all')"
        >全部</view>
        <view 
          class="filter-item" 
          :class="{'active': activeFilter === 'pending'}"
          @click="setFilter('pending')"
        >待处理</view>
        <view 
          class="filter-item" 
          :class="{'active': activeFilter === 'completed'}"
          @click="setFilter('completed')"
        >已完成</view>
      </view>
      
      <view class="download-list">
        <block v-if="filteredDownloads.length > 0">
          <view 
            class="download-item"
            v-for="(item, index) in filteredDownloads"
            :key="index"
          >
            <image class="map-thumb placeholder-image" :src="item.image"></image>
            
            <view class="download-info">
              <view class="map-title">{{item.title}}</view>
              <view class="download-time">申请时间：{{item.applyTime}}</view>
              <view class="download-status">
                <text :class="getStatusClass(item.status)">{{getStatusText(item.status)}}</text>
              </view>
            </view>
            
            <view class="action-btn" v-if="item.status === 'completed'">
              <button class="download-btn primary-bg" @click="downloadAgain(item)">重新下载</button>
            </view>
            <view class="action-btn" v-else-if="item.status === 'pending'">
              <text class="pending-text">处理中</text>
            </view>
            <view class="action-btn" v-else>
              <button class="reapply-btn" @click="reapplyDownload(item)">重新申请</button>
            </view>
          </view>
        </block>
        <view class="empty-list" v-else>
          <image class="empty-icon placeholder-image" src="/static/empty.png"></image>
          <view class="empty-text">暂无下载记录</view>
          <button class="browse-btn btn-primary" @click="navigateToHome">去浏览</button>
        </view>
      </view>
    </view>
  </view>
</template>

<script>
export default {
  data() {
    return {
      // 筛选条件
      activeFilter: 'all',
      // 下载记录
      downloads: []
    }
  },
  computed: {
    // 根据筛选条件过滤下载记录
    filteredDownloads() {
      if (this.activeFilter === 'all') {
        return this.downloads;
      } else if (this.activeFilter === 'pending') {
        return this.downloads.filter(item => item.status === 'pending');
      } else if (this.activeFilter === 'completed') {
        return this.downloads.filter(item => item.status === 'completed');
      }
      return this.downloads;
    }
  },
  onLoad() {
    this.getDownloadHistory();
  },
  onShow() {
      // 每次页面显示时刷新，确保实时更新
      this.getDownloadHistory();
    },
  methods: {
    // 获取下载记录
    getDownloadHistory() {
      console.log('获取下载记录');
      // 模拟API调用
      uni.request({
        url: '/api/user/downloads',
        success: (res) => {
          this.downloads = res.data.downloads;
        }
      });
    },
    
    // 设置筛选条件
    setFilter(filter) {
      this.activeFilter = filter;
    },
    
    // 获取状态显示文本
    getStatusText(status) {
      switch (status) {
        case 'completed':
          return '已完成';
        case 'pending':
          return '处理中';
        case 'rejected':
          return '已拒绝';
        case 'expired':
          return '已过期';
        default:
          return '未知状态';
      }
    },
    
    // 获取状态样式类
    getStatusClass(status) {
      switch (status) {
        case 'completed':
          return 'status-completed';
        case 'pending':
          return 'status-pending';
        case 'rejected':
          return 'status-rejected';
        case 'expired':
          return 'status-expired';
        default:
          return '';
      }
    },
    
    // 重新下载
    downloadAgain(item) {
      // 模拟下载操作
      uni.showLoading({
        title: '准备下载...'
      });
      
      // 模拟API调用
      // uni.downloadFile({
      //   url: item.downloadUrl,
      //   success: (res) => {
      //     if (res.statusCode === 200) {
      //       uni.saveFile({
      //         tempFilePath: res.tempFilePath,
      //         success: () => {
      //           uni.hideLoading();
      //           uni.showToast({
      //             title: '下载成功',
      //             icon: 'success'
      //           });
      //         }
      //       });
      //     }
      //   },
      //   fail: () => {
      //     uni.hideLoading();
      //     uni.showToast({
      //       title: '下载失败',
      //       icon: 'none'
      //     });
      //   }
      // });
      
      // 模拟成功
      setTimeout(() => {
        uni.hideLoading();
        uni.showToast({
          title: '下载成功',
          icon: 'success'
        });
      }, 1500);
    },
    
    // 重新申请下载
    reapplyDownload(item) {
      uni.navigateTo({
        url: `/pages/map/detail?id=${item.id}`
      });
    },
    
    // 导航到首页
    navigateToHome() {
      uni.switchTab({
        url: '/pages/index/index'
      });
    }
  }
}
</script>

<style>
.container {
  position: relative;
  min-height: 100vh;
  width: 100%;
  overflow: hidden;
  padding-bottom: 30rpx;
}

.background {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  z-index: -1;
}

.background-image {
  width: 100%;
  height: 100%;
  object-fit: cover; /* For web compatibility */
}

.content {
  position: relative;
  z-index: 1;
}

/* 标题栏 */
.header {
  padding: 20rpx 30rpx;
}

/*.header {
  padding: 20rpx 30rpx;
  background-color: #FFFFFF;
  border-bottom: 1px solid #EEEEEE;
}*/

.title {
  font-size: 32rpx;
  font-weight: bold;
  color: #333333;
}

/* 筛选栏 */
.filter-bar {
  display: flex;
  background-color: #FFFFFF;
  padding: 20rpx 0;
  margin-bottom: 20rpx;
  border-bottom: 1px solid #EEEEEE;
}

.filter-item {
  flex: 1;
  text-align: center;
  font-size: 28rpx;
  color: #666666;
  position: relative;
}

.filter-item.active {
  color: #7aa26f; /* Updated green color */
  font-weight: bold;
}

.filter-item.active::after {
  content: '';
  position: absolute;
  bottom: -20rpx;
  left: 50%;
  transform: translateX(-50%);
  width: 40rpx;
  height: 4rpx;
  background-color: #7aa26f; /* Updated green color */
}

/* 下载列表 */
.download-list {
  padding: 0 20rpx;
}

.download-item {
  display: flex;
  padding: 20rpx;
  background-color: #FFFFFF;
  border-radius: 10rpx;
  margin-bottom: 20rpx;
  box-shadow: 0 2rpx 10rpx rgba(0, 0, 0, 0.05);
}

.map-thumb {
  width: 120rpx;
  height: 120rpx;
  border-radius: 10rpx;
}

.download-info {
  flex: 1;
  margin-left: 20rpx;
  overflow: hidden;
}

.map-title {
  font-size: 28rpx;
  color: #333333;
  margin-bottom: 10rpx;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.download-time {
  font-size: 24rpx;
  color: #999999;
  margin-bottom: 10rpx;
}

.download-status {
  font-size: 24rpx;
}

.status-completed {
  color: #7aa26f; /* Updated green color */
}

.status-pending {
  color: #FFA500;
}

.status-rejected {
  color: #FF0000;
}

.status-expired {
  color: #999999;
}

/* 操作按钮 */
.action-btn {
  display: flex;
  align-items: center;
  padding-left: 20rpx;
}

.download-btn, .reapply-btn {
  width: 160rpx;
  height: 60rpx;
  line-height: 60rpx;
  font-size: 24rpx;
  border-radius: 30rpx;
  text-align: center;
}

.download-btn {
  color: #FFFFFF;
  background-color: #7aa26f; /* Updated green color */
}

.reapply-btn {
  color: #7aa26f; /* Updated green color */
  border: 1px solid #7aa26f; /* Updated green color */
  background-color: #FFFFFF;
}

.pending-text {
  font-size: 24rpx;
  color: #FFA500;
}

/* 空列表 */
.empty-list {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  padding: 100rpx 0;
}

.empty-icon {
  width: 200rpx;
  height: 200rpx;
  margin-bottom: 30rpx;
}

.empty-text {
  font-size: 30rpx;
  color: #999999;
  margin-bottom: 30rpx;
}

.browse-btn {
  width: 200rpx;
  height: 80rpx;
  line-height: 80rpx;
  font-size: 28rpx;
  color: #FFFFFF;
  background-color: #7aa26f; /* Updated green color */
  border-radius: 10rpx;
}
</style>